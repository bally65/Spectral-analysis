<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…‰è­œç·šæ€§å›æ­¸åˆ†æå„€ | Molty Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8fafc; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; }
        .lab-card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: #3498db; transition: 0.3s; }
        .btn-primary:hover { background-color: #2980b9; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <div class="text-center mb-10">
            <h1 class="text-3xl font-bold text-slate-800">å…‰è­œç·šæ€§å›æ­¸åˆ†æ</h1>
            <p class="text-blue-500 font-medium">Spectral Linear Regression Tool</p>
            <p class="text-slate-500 text-sm mt-2">å°ˆæ¥­åŒ–å­¸åˆ†æå·¥å…·ï¼Œè‡ªå‹•æ“¬åˆæ¨™æº–æ›²ç·šèˆ‡æ¨£æœ¬æ›ç®—</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-6">
                <!-- Data Input Card -->
                <div class="lab-card p-6">
                    <h2 class="text-lg font-bold text-slate-700 mb-4 flex items-center">
                        <span class="mr-2">ğŸ“Š</span> æ¨™æº–å“æ•¸æ“š (Standards)
                    </h2>
                    <table class="w-full text-sm mb-4" id="dataTable">
                        <thead>
                            <tr class="text-slate-500 border-b">
                                <th class="py-2 text-left">æ¿ƒåº¦ (x)</th>
                                <th class="py-2 text-left">å¸å…‰åº¦ (y)</th>
                                <th class="py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="dataBody">
                            <tr>
                                <td class="py-2"><input type="number" class="w-20 border rounded px-2 py-1 x-val" value="0"></td>
                                <td class="py-2"><input type="number" class="w-20 border rounded px-2 py-1 y-val" value="0"></td>
                                <td class="py-2"></td>
                            </tr>
                            <tr>
                                <td class="py-2"><input type="number" class="w-20 border rounded px-2 py-1 x-val" value="10"></td>
                                <td class="py-2"><input type="number" class="w-20 border rounded px-2 py-1 y-val" value="0.15"></td>
                                <td class="py-2"></td>
                            </tr>
                        </tbody>
                    </table>
                    <button onclick="addRow()" class="w-full py-2 border-2 border-dashed border-slate-300 text-slate-500 rounded-lg hover:bg-slate-50">+ æ–°å¢æ•¸æ“šé»</button>
                    <button onclick="calculate()" class="w-full mt-4 btn-primary text-white font-bold py-2 rounded-lg shadow-lg">åŸ·è¡Œç·šæ€§å›æ­¸</button>
                </div>

                <!-- Unknown Sample Card -->
                <div class="lab-card p-6 bg-blue-50 border border-blue-100">
                    <h2 class="text-lg font-bold text-blue-700 mb-4">ğŸ§ª æœªçŸ¥æ¨£æœ¬æ›ç®—</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-blue-600 font-bold">è¼¸å…¥æ¨£å“å¸å…‰åº¦ (y)</label>
                            <input type="number" id="unknownY" class="w-full border rounded px-3 py-2 mt-1" placeholder="ä¾‹å¦‚: 0.45">
                        </div>
                        <div class="pt-2 border-t border-blue-200">
                            <p class="text-sm text-slate-600">è¨ˆç®—çµæœæ¿ƒåº¦ (x):</p>
                            <p id="resultX" class="text-2xl font-bold text-blue-600">--</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visualization & Results -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Statistics Row -->
                <div class="lab-card p-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <p class="text-xs text-slate-400">å›æ­¸æ–¹ç¨‹å¼</p>
                        <p id="formulaText" class="font-mono font-bold text-slate-700">y = mx + b</p>
                    </div>
                    <div>
                        <p class="text-xs text-slate-400">æ–œç‡ (m)</p>
                        <p id="valM" class="font-bold text-slate-700">0.0000</p>
                    </div>
                    <div>
                        <p class="text-xs text-slate-400">æˆªè· (b)</p>
                        <p id="valB" class="font-bold text-slate-700">0.0000</p>
                    </div>
                    <div>
                        <p class="text-xs text-slate-400">ç›¸é—œä¿‚æ•¸ (RÂ²)</p>
                        <p id="valR2" class="font-bold text-green-600">0.0000</p>
                    </div>
                </div>

                <!-- Chart Card -->
                <div class="lab-card p-6">
                    <canvas id="regressionChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart;
        let regressionModel = { m: 0, b: 0 };

        function addRow() {
            const tbody = document.getElementById('dataBody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="py-2"><input type="number" class="w-20 border rounded px-2 py-1 x-val"></td>
                <td class="py-2"><input type="number" class="w-20 border rounded px-2 py-1 y-val"></td>
                <td class="py-2 text-right"><button onclick="this.parentElement.parentElement.remove()" class="text-red-400 hover:text-red-600">âœ•</button></td>
            `;
            tbody.appendChild(tr);
        }

        function calculate() {
            const xInputs = document.querySelectorAll('.x-val');
            const yInputs = document.querySelectorAll('.y-val');
            let data = [];

            xInputs.forEach((input, i) => {
                if(input.value !== "" && yInputs[i].value !== "") {
                    data.push({x: parseFloat(input.value), y: parseFloat(yInputs[i].value)});
                }
            });

            if(data.length < 2) return alert("è«‹è‡³å°‘è¼¸å…¥å…©çµ„æ•¸æ“š");

            const n = data.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;

            data.forEach(p => {
                sumX += p.x;
                sumY += p.y;
                sumXY += p.x * p.y;
                sumX2 += p.x * p.x;
                sumY2 += p.y * p.y;
            });

            const m = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const b = (sumY - m * sumX) / n;

            const numerator = Math.pow((n * sumXY - sumX * sumY), 2);
            const denominator = (n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY);
            const r2 = numerator / denominator;

            regressionModel = { m, b };

            document.getElementById('valM').innerText = m.toFixed(4);
            document.getElementById('valB').innerText = b.toFixed(4);
            document.getElementById('valR2').innerText = r2.toFixed(4);
            document.getElementById('formulaText').innerText = `y = ${m.toFixed(4)}x ${b >= 0 ? '+' : ''} ${b.toFixed(4)}`;

            updateChart(data, m, b);
            updateUnknown();
        }

        function updateChart(data, m, b) {
            const ctx = document.getElementById('regressionChart').getContext('2d');
            const minX = Math.min(...data.map(p => p.x));
            const maxX = Math.max(...data.map(p => p.x));
            const lineData = [
                {x: minX, y: m * minX + b},
                {x: maxX, y: m * maxX + b}
            ];

            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'æ¨™æº–å“æ•¸æ“šé»',
                        data: data,
                        backgroundColor: '#3498db'
                    }, {
                        label: 'ç·šæ€§è¶¨å‹¢ç·š',
                        data: lineData,
                        type: 'line',
                        borderColor: '#e74c3c',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: 'æ¿ƒåº¦ (Concentration)' } },
                        y: { title: { display: true, text: 'å¸å…‰åº¦ (Absorbance)' } }
                    }
                }
            });
        }

        function updateUnknown() {
            const y = parseFloat(document.getElementById('unknownY').value);
            if(!isNaN(y) && regressionModel.m !== 0) {
                const x = (y - regressionModel.b) / regressionModel.m;
                document.getElementById('resultX').innerText = x.toFixed(4);
            }
        }

        document.getElementById('unknownY').addEventListener('input', updateUnknown);
        calculate();
    </script>
</body>
</html>
